!function(t){function e(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=57)}([function(t,e){t.exports=require("mongoose")},function(t,e){t.exports=require("mongoose-paginate")},function(t,e,n){"use strict";t.exports=n(5)},function(t,e){t.exports=require("mix-utils")},function(t,e){t.exports=require("async")},function(t,e,n){"use strict";t.exports={port:{www:8070,api:8090,admin:8080},db:"mongodb://localhost/pinterest",secret:"78ad3c62b2f44ec3b65f09ebf1236a6c3c56656d6593b39c250646ee375d2075",log:{collection:"logs",level:"all"},aws:{clientID:"AKIAJGNVNF32R6UBI4XQ",clientSecret:"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",region:"us-east-1",bucket:"i.geekrill.com"},facebook:{clientID:"687615191258150",clientSecret:"4f09bd8ee3a6cff3711200f9ef2e1045",callbackURL:"http://localhost:8080/auth/facebook/callback"},twitter:{clientID:"XVuGpFDcCIfIVZfhqkMiNjSuu",clientSecret:"0wp1Q50DPjtlqX8LtgoBWCqRxpJtxKXwpmmplwhYDOEMJzXPGA",callbackURL:"http://localhost:8080/auth/twitter/callback"},tumblr:{clientID:"sC2hNnCfMHYFh84vEWB6icAuSkFdupIBo1cdrpGMMCPHBvskEP",clientSecret:"ww3bd7R4o5LtOBFvTwnH0MkUx3UMGQuWLrm3LxCUYO5j3vUsuj",callbackURL:"http://localhost:8080/auth/tumblr/callback"},google:{clientID:"Google Application ID",clientSecret:"Google Application Secret",callbackURL:"http://localhost:8080/oauth/google/callback"},mail:{sparkpost:{ApiKey:"791214ab9be4177dee42f5b84e91e25f371348ae"}}}},,function(t,e,n){"use strict";var o=n(0),i=n(1),r=(n(10),new o.Schema({_uid:o.Schema.Types.ObjectId,_cid:o.Schema.Types.ObjectId,tk:String,br:String,tl:String,nt:String,img:String,link:String,url:String,stt:{type:Number,default:0},rt:{type:Number,default:0},at:{type:Date,default:Date.now},crt:{type:Date,default:Date.now}},{collection:"posts"}).plugin(i));t.exports=o.model("post",r)},function(t,e){t.exports=require("moment")},,function(t,e){t.exports=require("shortid")},,,,,function(t,e,n){"use strict";var o=n(34),i=n(2);n(35).MongoDB,o.add(o.transports.MongoDB,{db:i.db,level:i.log.level,collection:"logs"}),t.exports=o},function(t,e,n){"use strict";var o=n(0),i=n(1),r=new o.Schema({_uid:o.Schema.Types.ObjectId,_aid:o.Schema.Types.ObjectId,user:{},access_token:{type:String,unique:!0,index:!0},msg:{type:String,default:null},rt:{type:Number,default:1},stt:{type:Number,default:1},at:{type:Date,default:Date.now},crt:{type:Date,default:Date.now}},{collection:"chanels"}).plugin(i);t.exports=o.model("chanel",r)},,function(t,e){t.exports=require("core-js/library/web/timers")},function(t,e,n){"use strict";var o=n(0);t.exports=o.model("following",new o.Schema({_uid:o.Schema.Types.ObjectId,_tid:o.Schema.Types.ObjectId,tk:String,lnk:String,stt:{type:Number,default:0},rt:{type:Number,default:0},at:{type:Date,default:Date.now},crt:{type:Date,default:Date.now}},{collection:"followings"}))},function(t,e){t.exports=require("request")},function(t,e,n){"use strict";var o=n(0),i=n(1),r=new o.Schema({_uid:o.Schema.Types.ObjectId,_cid:o.Schema.Types.ObjectId,access_token:String,link:String,desc:String,board:String,tmp:String,rt:{type:Number,default:0},stt:{type:Number,default:1},crt:{type:Date,default:Date.now},at:{type:Date,default:Date.now}},{collection:"rss"}).plugin(i);t.exports=o.model("rss",r)},,,,,,,,,,,function(t,e){t.exports=require("cluster")},function(t,e){t.exports=require("os")},function(t,e){t.exports=require("winston")},function(t,e){t.exports=require("winston-mongodb")},function(t,e){t.exports=require("babel-runtime/core-js/object/keys")},function(t,e,n){"use strict";var o=n(0),i=n(1),r=new o.Schema({_uid:o.Schema.Types.ObjectId,name:{type:String,index:!0},key:{type:String,unique:!0,index:!0},serect:String,img:String,redirect:String,stt:{type:Number,default:0},crt:{type:Date,default:Date.now}},{collection:"apps"}).plugin(i);t.exports=o.model("app",r)},function(t,e,n){"use strict";var o=n(36),i=function(t){return t&&t.__esModule?t:{default:t}}(o),r=n(18),a=n(8),c=n(4),s=n(19),l=n(16),u=(n(37),n(7)),d=n(15),f=n(20);t.exports={following:function(t){var e=this;try{var n={_id:t._cid,access_token:t.tk};e.checkAccount(n,function(e,n){n?(0,r.setTimeout)(function(){f.post({url:"https://api.pinterest.com/v1/me/following/users/?access_token="+n.access_token,form:{user:t.lnk}},function(e,n,o){if(e)return callback(e,null);JSON.parse(o).message?s.findById(t._id,function(e,n){e&&d.info("ERROR :",e),n&&(n.rt=n.rt+1,3!=n.rt?(n._at=a(n._at).add(1,"days").toDate(),n.save(),d.info("FOLLOW JOB LINK RT++ ",n)):s.findById(t._id,function(e,n){e&&d.info("ERROR :",e),n&&(n.stt=7,n.save(),d.info("FOLLOW JOB FAIL ",t.lnk))}))}):s.findById(t._id,function(t,e){t&&d.info("ERROR :",t),e&&(e.stt=1,e.save(),d.info("FOLLOW JOB LINK SUCCESS ",e.lnk))})})},3e3):s.findById(t._id,function(e,n){e&&d.info("ERROR :",e),n&&(n.stt=7,n.save(),d.info("FOLLOW JOB FAIL ",t.lnk))})})}catch(t){t&&d.info("ERROR :",t)}},post:function(t){var e=this,n={_id:t._cid,access_token:t.tk};e.checkAccount(n,function(e,n){n&&u.findById(t._id,function(e,n){if(n){var o={access_token:t.tk,link:t.link,image_url:t.img,board:t.br,note:t.nt};f.post({url:"https://api.pinterest.com/v1/pins/",form:o},function(t,e,o){t&&d.info("ERROR POST PINT ",t),JSON.parse(o).data?(n.rt=3,n.stt=1,n.save(function(t,e){t&&d.info("ERROR :",t),e&&d.info("POST JOB SUCCESS ",e.nt)})):(n.rt=n.rt+1,3!=n.rt?(n.stt=9,n._at=a(n._at).add(1,"days").toDate(),n.save(function(t,e){t&&d.info("ERROR :",t),e&&d.info("POST JOB RT ++ ",e.tl)})):(n.stt=7,n.save(),d.info("POST JOB STATUS ",n.tl)))})}})})},checkAccount:function(t,e){var n=this;t&&f.get("https://api.pinterest.com/v1/me/?access_token="+t.access_token+"&fields=first_name%2Cid%2Clast_name%2Curl%2Ccounts%2Ccreated_at%2Cbio%2Caccount_type%2Cimage%2Cusername",function(o,i,r){o&&e(o,null);var a=JSON.parse(r);d.info("CHANEL STATUS "+t._id,a.data.username),a.data?l.findByIdAndUpdate(t._id,{$set:{rt:0}},function(t,o){t&&e(t,null),o?(n.info(o,a),e(null,o)):e(null,null)}):l.findById(t._id,function(t,n){t&&e(t,null),n?3==n.rt?(l.findByIdAndUpdate(n._id,{$set:{stt:7,msg:"Account stop by account not load info"}},function(t,e){}),u.findOneAndUpdate({_cid:n._id},{$set:{stt:7}},function(t,e){}),Rss.findOneAndUpdate({_cid:n._id},{$set:{stt:7}},function(t,e){}),s.findOneAndUpdate({_tid:n._id},{$set:{stt:7}},function(t,e){}),e(null,null)):(l.findByIdAndUpdate(n._id,{$inc:{rt:1,stt:9}},function(t,e){}),e(null,null)):e(null,null)})})},info:function(t,e){c.series([function(e){u.count({_cid:t._id,stt:{$in:1}},function(t,n){t?e(t,null):e(null,n)})},function(e){u.count({_cid:t._id,stt:{$in:[0,9]}},function(t,n){t?e(t):e(null,n)})}],function(n,o){n&&d.info("ERROR :",n);var r=o[0],a=o[1],c={id:e.data.id,br:e.data.counts.boards,flow:e.data.counts.followers,flowing:e.data.counts.following,pin:e.data.counts.pins,fn:e.data.username,img:e.data.image[(0,i.default)(e.data.image)[0]].url,ps:r,pd:a};t.user=c,t.save(function(t,e){t&&d.info("ERROR :",t),e&&d.info("LOAD UPDATE CHANEL SUCCESS",e.user.username)})})}}},function(t,e){t.exports=require("moment-timezone")},,,,,,,,,,,,,,,,,,function(t,e,n){"use strict";var o=n(32),i=n(33);if(o.isMaster){var r=i.cpus().length;console.log("Master cluster setting up "+r+" workers...");for(var a=0;a<r;a++)setTimeout(function(){o.fork()},18e4*a);o.on("online",function(t){console.log("Worker "+t.process.pid+" is online")}),o.on("exit",function(t,e,n){console.log("Worker "+t.process.pid+" died with code: "+e+", and signal: "+n),console.log("Starting a new worker"),o.fork()})}else n(58).init()},function(t,e,n){"use strict";var o=(n(18),n(4),n(39)),i=n(59),r=n(0),a=n(3),c=(n(16),n(19)),s=n(7),l=n(21),u=n(60),d=n(15),f=n(2);t.exports={agenda:null,stop:function(t){this.agenda.stop(t)},init:function(){r.Promise=global.Promise,r.connect(f.db);var t=this.agenda=new i({name:"pinterest-job-"+process.pid,defaultLockLimit:0,defaultLockLifetime:1e4,db:{address:f.db,collection:"jobs"}});t.define("feed",{priority:"normal"},function(e){var i=e.attrs.data;try{if(a.isNullOrUndefined(i)){var r=o().add(-10,"seconds").toDate();l.find({stt:1,at:{$lt:r},rt:{$lt:7}}).sort({_id:-1}).exec(function(e,n){if(console.log("RSS DOCUMETN MATCH"),console.log(n),console.log("END SHOW RSS DOCUMETN MATCH"),n.length>0){n.forEach(function(e){e.at<new Date&&t.schedule(e.at,"feed",{_cid:e._cid.toString(),_uid:e._uid.toString(),_id:e._id.toString(),access_token:e.access_token,link:e.link,tmp:e.tmp,board:e.board,rt:e.rt,stt:e.stt,at:e.at},function(t,n){t&&d.info("RSS error:",t),d.info("RSS LOGGER:",e.at,e._cid,e.lnk)})})}})}else n(61).feed(i)}catch(t){d.error("feed job",t)}}),t.define("post",{priority:"normal"},function(e){try{if(a.isNullOrUndefined(_data)){var i=o().add(-20,"minutes").format().toDate();c.aggregate({$match:{stt:{$in:[0,9]},at:{$lt:i},rt:{$lt:3}}},{$sort:{at:-1}},{$group:{_id:"$_cid",items:{$push:{_id:"$_id",_uid:"$_uid",_tid:"$_tid",user:"$user",lnk:"$lnk",at:"$at",rt:"$rt",stt:"$stt"}}}}).exec(function(e,n){console.log(n),n&&a.forEach(n,function(e,n){a.forEach(e.items,function(e,n){n<1&&e.at<new Date&&t.schedule(e.at,"post",{cid:e._cid.toString(),uid:e._uid.toString(),id:e._id.toString(),txt:e.txt,media:e.media,rt:e.rt,stt:e.stt},function(t,n){t&&d.info("POST LOGGER ERR:",t),d.info("RSS LOGGER:",e.at,e._cid,e.lnk)})})})})}else null!=_data&&n(38).post(_data)}catch(t){d.error("follow job",t)}}),t.define("following",{priority:"normal"},function(e){var i=e.attrs.data;try{if(a.isNullOrUndefined(i)){var r=o().add(-10,"seconds").toDate();c.aggregate({$match:{stt:{$in:[0,9]},at:{$lt:r},rt:{$lt:3}}},{$sort:{at:1}},{$group:{_id:"$_tid",items:{$push:{_id:"$_id",_uid:"$_uid",_tid:"$_tid",user:"$user",tk:"$tk",lnk:"$lnk",at:"$at",rt:"$rt",stt:"$stt"}}}}).exec(function(e,n){n&&a.forEach(n,function(e,n){a.forEach(e.items,function(e,n){n<1&&t.schedule(e.at,"following",{_id:e._id,_uid:e._uid,_cid:e._tid,tk:e.tk,lnk:e.lnk,stt:e.stt,rt:e.rt,at:e.at},function(t,n){t&&d.info("ERROR :",t),d.info("FOLLOWING LOGGER :",e.at,e._cid,e.lnk)})})})})}else n(38).following(i)}catch(t){d.error("follow job",t)}}),t.define("post",{priority:"normal"},function(e){var i=e.attrs.data;try{if(a.isNullOrUndefined(i)){var r=o().add(-10,"minutes").toDate();s.aggregate({$match:{stt:{$in:[0,9]},at:{$lt:r},rt:{$lt:3}}},{$sort:{at:1}},{$group:{_id:"$_cid",items:{$push:{_id:"$_id",_uid:"$_uid",_cid:"$_cid",tk:"$tk",br:"$br",nt:"$nt",tl:"$tl",img:"$img",at:"$at",rt:"$rt",stt:"$stt"}}}}).exec(function(e,n){n&&a.forEach(n,function(n,o){a.forEach(n.items,function(n,o){o<1&&n.at<new Date&&t.schedule(n.at,"post",{_cid:n._cid.toString(),_uid:n._uid.toString(),_id:n._id.toString(),tk:n.tk,br:n.br,nt:n.nt,tl:n.tl,img:n.img,rt:n.rt,stt:n.stt},function(t,o){e&&d.info("POST error:",e),d.info("POST LOGGER :",n.at,n._cid,n.lnk)})})})})}else i&&n(38).post(i)}catch(t){d.error("post job",t)}}),t.define("clean",{priority:"normal"},function(t){var e=o().add(-60,"days").endOf("day").toDate();l.remove({stt:7,at:{$lt:e}},function(t,e){}),s.remove({stt:7,at:{$lt:e}},function(t,e){}),c.remove({stt:7},function(t,e){}),u.remove({timestamp:{$lt:e}},function(t,e){})}),t.on("ready",function(){t.every("5 seconds","feed"),t.every("25 seconds","post"),t.every("20 seconds","following"),t.every("1 days","clean"),t.start()});var e=15;!function(){if(e<10)var t=5;console.log(t)}(),process.on("SIGTERM",function(){t.stop(function(){process.exit(0)})}),process.on("SIGINT",function(){t.stop(function(){process.exit(0)})}),t.on("success",function(t){console.log("job %s finished at: %s",t.attrs.name,o().format()),"single"!=t.attrs.type&&t.remove()}),t.on("start",function(t){console.log("job %s starting at: %s",t.attrs.name,o().format())})}}},function(t,e){t.exports=require("agenda")},function(t,e,n){"use strict";var o=n(0);t.exports=o.model("log",new o.Schema({timestamp:Date,level:String,message:String,meta:{}},{collection:"logs"}))},function(t,e,n){"use strict";var o=n(62),i=function(t){return t&&t.__esModule?t:{default:t}}(o),r=n(63),a=n(4),c=n(3),s=n(20),l=n(39),u=(n(16),n(21)),d=n(10),f=n(15),p=n(7);t.exports={feed:function(t){console.log(t),console.log("RUN IN DATA"),a.waterfall([function(e){r.load(t.link,function(t,n){if(t&&f.error("rss to json",t),n&&n.items&&n.items.length>0){var o=n.items;f.info("LOAD POST RSS COUNT ",o.length),e(null,o)}})},function(e,n){console.log(e),console.log("RUN RSS ITEM DATA 1"),p.find({_cid:t._cid}).sort({at:-1}).exec(function(t,o){if(t&&console.log(t),o.length>0)c.first(o,function(t){var o=t.at,i=l(o).add(1,"hours").toDate();n(null,e,i)});else{var i=l().add(-4,"hours").toDate();n(null,e,i)}})},function(e,n,o){if(console.log(n),console.log(e),console.log("RUN RSS ITEM DATA 2"),e.length>0){var r=(e.length,[]),u=!0,f=!1,p=void 0;try{for(var g,m=(0,i.default)(e);!(u=(g=m.next()).done);u=!0)!function(){var e=g.value,o=function(o){s.post({url:"https://api.viralnk.com/short",headers:{"X-Token":"ab5755b2777ace8e52d1f4edeb03a3cdb8c35d78e14d5b5cae086edd8ad05f86","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:45.0) Gecko/20100101 Firefox/45.0"},form:{url:e.link}},function(i,r,a){if(!i&&200==r.statusCode){var s=JSON.parse(a),u=c.truncate(e.title,{length:60,separator:/,? +/}),f=d.generate();if(1==s.stt){var p=Math.floor(3601*Math.random()+7200);n=l(n).add(p,"seconds").toDate();var g=s.url,m=c.isNullOrUndefined(e.enclosures)?"http://mb3egypt.com/img/not-available.jpg":e.enclosures[0].url,_={_uid:t._uid,_cid:t._cid,tk:t.access_token,br:t.board,tl:u,nt:t.tmp.replace(/{title}/gi,u).replace(/{url}/gi,g).replace(/{random}/,f),img:m,link:g,at:n};o(null,_)}}})};r.push(o)}()}catch(t){f=!0,p=t}finally{try{!u&&m.return&&m.return()}finally{if(f)throw p}}a.series(r,function(t,e){o(null,e)})}else o(null,null)},function(e,n){e?p.find({_cid:t._cid},function(t,o){if(t&&console.log(t),o){var i=c.differenceBy(e,o,"title");n(null,i)}else n(null,e)}):n(null,null)}],function(e,n){u.findById(t._id,function(t,e){t&&console.log(t),e&&n.length>0?p.create(n,function(t,n){t&&console.log(t),n?(e.rt=0,e.at=l(e.at).add(1,"days").toDate(),e.save()):(e.at=l(e.at).add(12,"hours").toDate(),e.save())}):(console.log("KO CO POST MOI THU LAI 1 NGAY SAU NEU 5 NGAY KO DC XOA BAN GHI"),7!=e.rt?(e.rt=e.rt+1,e.at=l(e.at).add(1,"days").toDate(),e.save()):(e.stt=7,e.save()))})})}}},function(t,e){t.exports=require("babel-runtime/core-js/get-iterator")},function(t,e){t.exports=require("rss-to-json")}]);